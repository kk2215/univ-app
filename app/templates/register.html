{% extends 'base.html' %}

{% block title %}ユーザー初期登録{% endblock %}

{% block content %}
<article>
    <hgroup>
        <h1>ユーザー初期登録</h1>
        <h2>あなたの情報を入力してください</h2>
    </hgroup>
    <form method="post">
        <label for="username">ユーザー名
    <input type="text" id="username" name="username" placeholder="半角英数字" required>
</label>
<div class="grid">
    <label for="password">パスワード
        <input type="password" id="password" name="password" required>
    </label>
    <label for="password_confirm">パスワード（確認用）
        <input type="password" id="password_confirm" name="password_confirm" required>
    </label>
</div>
<hr>
        {% if error %}
        <p style="color: red;"><strong>{{ error }}</strong></p>
        {% endif %}
        <div class="grid">
            <label for="grade">学年
                <select name="grade" id="grade" required>
                    <option value="" disabled selected>選択してください</option>
                    <option value="high1">高校1年生</option>
                    <option value="high2">高校2年生</option>
                    <option value="high3">高校3年生</option>
                    <option value="ronin">浪人生</option>
                </select>
            </label>
            <label for="course_type">文理選択
                <select name="course_type" id="course_type" required>
                    <option value="" disabled selected>選択してください</option>
                    <option value="liberal_arts">文系</option>
                    <option value="science">理系</option>
                </select>
            </label>
        </div>

        <label for="prefecture">お住まいの都道府県 (任意)
            <select name="prefecture" id="prefecture">
                <option value="">選択しない</option>
                <option value="北海道">北海道</option>
                <option value="青森県">青森県</option>
                <option value="岩手県">岩手県</option>
                <option value="宮城県">宮城県</option>
                <option value="秋田県">秋田県</option>
                <option value="山形県">山形県</option>
                <option value="福島県">福島県</option>
                <option value="茨城県">茨城県</option>
                <option value="栃木県">栃木県</option>
                <option value="群馬県">群馬県</option>
                <option value="埼玉県">埼玉県</option>
                <option value="千葉県">千葉県</option>
                <option value="東京都">東京都</option>
                <option value="神奈川県">神奈川県</option>
                <option value="新潟県">新潟県</option>
                <option value="富山県">富山県</option>
                <option value="石川県">石川県</option>
                <option value="福井県">福井県</option>
                <option value="山梨県">山梨県</option>
                <option value="長野県">長野県</option>
                <option value="岐阜県">岐阜県</option>
                <option value="静岡県">静岡県</option>
                <option value="愛知県">愛知県</option>
                <option value="三重県">三重県</option>
                <option value="滋賀県">滋賀県</option>
                <option value="京都府">京都府</option>
                <option value="大阪府">大阪府</option>
                <option value="兵庫県">兵庫県</option>
                <option value="奈良県">奈良県</option>
                <option value="和歌山県">和歌山県</option>
                <option value="鳥取県">鳥取県</option>
                <option value="島根県">島根県</option>
                <option value="岡山県">岡山県</option>
                <option value="広島県">広島県</option>
                <option value="山口県">山口県</option>
                <option value="徳島県">徳島県</option>
                <option value="香川県">香川県</option>
                <option value="愛媛県">愛媛県</option>
                <option value="高知県">高知県</option>
                <option value="福岡県">福岡県</option>
                <option value="佐賀県">佐賀県</option>
                <option value="長崎県">長崎県</option>
                <option value="熊本県">熊本県</option>
                <option value="大分県">大分県</option>
                <option value="宮崎県">宮崎県</option>
                <option value="鹿児島県">鹿児島県</option>
                <option value="沖縄県">沖縄県</option>
            </select>
        </label>
        
        <div class="grid">
            <label for="school">志望校
              <div class="autocomplete-wrapper">
              <input type="text" id="school" name="school" placeholder="例：早稲田大学" required>
              </div>
            </label>
            <label for="faculty">志望学部
              <select name="faculty" id="faculty" required disabled>
              <option value="">まず大学を選択してください</option>
              <label for="target_exam_date">第一志望の試験日 (任意)
            <input type="date" id="target_exam_date" name="target_exam_date">
        </label>
           </select>
</label>
        </div>
        <hr>
        
        <fieldset>
            <legend>受験科目を選択してください</legend>
            <div class="subject-grid">
                {% for subject in subjects %}
                <label for="subject_{{ subject.id }}">
                    <input type="checkbox" id="subject_{{ subject.id }}" name="subjects" value="{{ subject.id }}">
                    {{ subject.name }}
                </label>
                {% endfor %}   
            </div>
            <div>
                <legend>あなたの現在の実力に最も近いものを選択してください</legend>
            <label>
                <input type="radio" name="starting_level" value="0" checked>
                中学レベル・高校の最初の内容から復習したい
            </label>
            <label>
                <input type="radio" name="starting_level" value="1">
                高校の基礎は固まっている（日東駒専レベルから始めたい）
            </label>
            <label>
                <input type="radio" name="starting_level" value="2">
                日東駒専レベルはクリアしている（MARCHレベルから始めたい）
            </label> 
            </div>
        </fieldset>
        
        <button type="submit" class="contrast">学習計画を作成する</button>
    </form>
</article>
<script>
    const schoolInput = document.getElementById('school');
    const facultySelect = document.getElementById('faculty');
    const schoolSuggestions = document.createElement('div');
    schoolSuggestions.setAttribute('id', 'school-suggestions');
    schoolInput.parentElement.appendChild(schoolSuggestions);

    // 大学名の入力イベント
    schoolInput.addEventListener('input', async (e) => {
        const query = e.target.value;
        facultySelect.innerHTML = '<option value="">まず大学を選択してください</option>';
        facultySelect.disabled = true;

        if (query.length < 1) {
            schoolSuggestions.innerHTML = '';
            return;
        }

        const response = await fetch(`/api/universities?q=${query}`);
        const data = await response.json();
        
        schoolSuggestions.innerHTML = '';
        if (data.length > 0) {
            data.forEach(uni => {
                const item = document.createElement('div');
                item.classList.add('suggestion-item');
                item.textContent = uni;
                item.addEventListener('click', () => {
                    schoolInput.value = uni;
                    schoolSuggestions.innerHTML = '';
                    fetchFaculties(uni);
                });
                schoolSuggestions.appendChild(item);
            });
        }
    });

    // 学部候補をプルダウンとして取得・表示する関数
    // register.html の <script> タグ内、fetchFaculties 関数を置き換え

const fetchFaculties = async (universityName) => {
    const response = await fetch(`/api/faculties?univ=${encodeURIComponent(universityName)}`);
    const data = await response.json();
    
    facultySelect.innerHTML = '<option value="" disabled selected>学部を選択してください</option>';
    if (data.length > 0) {
        data.forEach(fac => {
            const option = document.createElement('option');
            option.value = fac;
            option.textContent = fac;
            facultySelect.appendChild(option);
        });
        // ▼▼▼ この行が重要です！▼▼▼
        facultySelect.disabled = false; // プルダウンメニューを有効化する
    } else {
        facultySelect.innerHTML = '<option value="">この大学の学部情報はありません</option>';
        facultySelect.disabled = true; // 候補がない場合は無効のまま
    }
};
    const subjectCheckboxes = document.querySelectorAll('.subject-checkbox');
    const startLevelSection = document.getElementById('start-level-section');

    const levelOptions = {
        0: '中学レベル・高校の最初の内容から復習したい',
        1: '高校の基礎は固まっている（日東駒専レベルから始めたい）',
        2: '日東駒専レベルはクリアしている（MARCHレベルから始めたい）'
    };

    subjectCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            const subjectId = e.target.value;
            const subjectName = e.target.dataset.subjectName;
            const existingLevelSelector = document.getElementById(`start-level-${subjectId}`);

            if (e.target.checked) {
                if (!existingLevelSelector) {
                    const fieldset = document.createElement('fieldset');
                    fieldset.id = `start-level-${subjectId}`;
                    let optionsHtml = `<legend>${subjectName}の開始レベルを選択</legend>`;
                    for (const [value, text] of Object.entries(levelOptions)) {
                        optionsHtml += `
                            <label>
                                <input type="radio" name="start_level_${subjectId}" value="${value}" ${value === '1' ? 'checked' : ''}>
                                ${text}
                            </label>
                        `;
                    }
                    fieldset.innerHTML = optionsHtml;
                    startLevelSection.appendChild(fieldset);
                }
            } else {
                if (existingLevelSelector) {
                    existingLevelSelector.remove();
                }
            }
        });
    });

    // 候補の外側をクリックしたら候補を閉じる
    document.addEventListener('click', (e) => {
        if (e.target !== schoolInput) {
            schoolSuggestions.innerHTML = '';
        }
    });
</script>
{% endblock %}