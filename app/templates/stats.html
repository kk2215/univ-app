{% extends "base.html" %}

{% block title %}学習記録{% endblock %}

{% block content %}
<article>
    <hgroup>
        <h1>学習記録</h1>
        <h2>カレンダーの日付をクリックして、学習時間を記録・編集しましょう。</h2>
    </hgroup>
</article>

<div class="grid">
    <article>
        <h3>科目別 合計学習時間</h3>
        <canvas id="subjectChart"></canvas>
    </article>
    <article>
        <h3>直近7日間の学習時間</h3>
        <canvas id="dailyChart"></canvas>
    </article>
</div>

<article>
    <div class="calendar-header">
        <a href="{{ url_for('main.stats', user_id=user.id, year=prev_month.year, month=prev_month.month) }}" role="button" class="secondary outline">&lt; 前の月</a>
        <h3>{{ year }}年 {{ month }}月</h3>
        {% if not is_future %}
        <a href="{{ url_for('main.stats', user_id=user.id, year=next_month.year, month=next_month.month) }}" role="button" class="secondary outline">次の月 &gt;</a>
        {% else %}
        <a role="button" class="secondary outline" disabled>次の月 &gt;</a>
        {% endif %}
    </div>

    <div id="cal-heatmap" style="margin-top: 2rem; margin-bottom: 2rem;"></div>

    <div class="calendar-grid">
        <div class="day-header">月</div><div class="day-header">火</div><div class="day-header">水</div><div class="day-header">木</div><div class="day-header">金</div><div class="day-header">土</div><div class="day-header">日</div>
        {% for week in calendar_data %}
            {% for day_data in week %}
                {% set day = day_data.date %}
                {% set is_this_month = "is-this-month" if day.month == month else "" %}
                {% set hours = (day_data.total_minutes / 60) | int %}{% set minutes = day_data.total_minutes % 60 %}
                {% set tooltip_text = day.strftime('%Y-%m-%d') + ': ' + hours|string + '時間' + minutes|string + '分' %}
                <div class="day {{ is_this_month }} study-level-{{ day_data.color_level }}" data-date="{{ day.isoformat() }}" title="{{ tooltip_text }}">
                    {{ day.day }}
                </div>
            {% endfor %}
        {% endfor %}
    </div>
</article>

<details>
    <summary><h3 style="display: inline-block; margin: 0;">最近の記録</h3></summary>
    <article style="padding-top: 0;">
        <table>
            <tbody>
                {% for log in recent_logs %}
                <tr>
                    <td>{{ log.name }}</td>
                    <td><strong>{{ log.duration_minutes }} 分</strong></td>
                    <td>
                        <form method="POST" action="{{ url_for('main.delete_log', log_id=log.id) }}" onsubmit="return confirm('本当にこの記録を削除しますか？');" style="margin: 0;">
                            <button type="submit" class="secondary outline" style="margin: 0;">削除</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </article>
</details>

<dialog id="log-modal">
    <article>
        <header>
            <a href="#close" aria-label="Close" class="close"></a>
            <h3 id="modal-title">学習を記録</h3>
        </header>
        <form id="log-form">
            <input type="hidden" id="log-date" name="date">
            {% for subject in user_subjects %}
            <div class="grid subject-log-row" data-subject-id="{{ subject.id }}" data-total-minutes="0">
                <label class="subject-label">{{ subject.name }}</label>
                <div class="time-controls">
                    <span class="time-display">0分</span>
                    <div class="button-group">
                        <button type="button" class="secondary outline time-btn" data-change="-15" aria-label="15分減らす">-15m</button>
                        <button type="button" class="secondary time-btn" data-change="15" aria-label="15分増やす">+15m</button>
                        <button type="button" class="secondary time-btn" data-change="30" aria-label="30分増やす">+30m</button>
                        <button type="button" class="contrast time-btn" data-change="60" aria-label="1時間増やす">+1h</button>
                    </div>
                </div>
            </div>
            {% endfor %}
            <label for="comment">コメント（任意）</label>
            <textarea id="log-comment" name="comment" rows="3" placeholder="今日の学習で気づいたこと、難しかったことなどを記録しよう"></textarea>
            <footer>
                <a href="#cancel" role="button" class="secondary" data-target="log-modal">キャンセル</a>
                <button type="submit" id="save-log-btn">この日の記録を保存</button>
            </footer>
        </form>
    </article>
</dialog>

{% block scripts %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.2/dist/cal-heatmap.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.2/dist/cal-heatmap.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // ▼▼▼ 改善2: グラフの単位を「時間」に変更 ▼▼▼
    const subjectCtx = document.getElementById('subjectChart');
    if (subjectCtx && {{ subject_labels | tojson }} && {{ subject_data | tojson }}.some(d => d > 0)) { 
        new Chart(subjectCtx, { 
            type: 'doughnut', 
            data: { 
                labels: {{ subject_labels | tojson }}, 
                datasets: [{ 
                    label: '学習時間 (時間)', 
                    data: {{ subject_data | tojson }},
                    backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'],
                }] 
            },
            options: {
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) { return context.label + ': ' + context.raw + ' 時間'; }
                        }
                    }
                }
            }
        }); 
    }
    
    const dailyCtx = document.getElementById('dailyChart');
    if (dailyCtx && {{ date_labels | tojson }} && {{ date_data | tojson }}.some(d => d > 0)) { 
        new Chart(dailyCtx, { 
            type: 'bar', 
            data: { 
                labels: {{ date_labels | tojson }}, 
                datasets: [{ 
                    label: '学習時間 (時間)', 
                    data: {{ date_data | tojson }}, 
                    backgroundColor: '#36a2eb', 
                }] 
            }, 
            options: { 
                scales: { 
                    y: { 
                        beginAtZero: true,
                        title: { display: true, text: '学習時間 (時間)' }
                    } 
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) { return context.dataset.label + ': ' + context.raw + ' 時間'; }
                        }
                    }
                }
            } 
        }); 
    }

    // --- ここから下は、新しいボタン式入力に対応したJavaScript ---
    const modal = document.getElementById('log-modal');
    const form = document.getElementById('log-form');
    const dateInput = document.getElementById('log-date');
    const commentInput = document.getElementById('log-comment');
    const modalTitle = document.getElementById('modal-title');
    const userSubjects = JSON.parse('{{ user_subjects|tojson|safe }}');
    const logsByDate = JSON.parse('{{ logs_by_date|tojson|safe }}');
    const calendarGrid = document.querySelector('.calendar-grid');

    function updateDisplay(subjectRow) {
        const totalMinutes = parseInt(subjectRow.dataset.totalMinutes, 10);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        const displaySpan = subjectRow.querySelector('.time-display');
        let displayText = '';
        if (hours > 0) displayText += `${hours}時間 `;
        if (minutes > 0) displayText += `${minutes}分`;
        if (displayText === '') displayText = '0分';
        displaySpan.textContent = displayText.trim();
    }

    if (calendarGrid) {
        calendarGrid.addEventListener('click', (e) => {
            const dayElement = e.target.closest('.day.is-this-month');
            if (!dayElement) return;

            const dateStr = dayElement.dataset.date;
            dateInput.value = dateStr;
            modalTitle.textContent = `${dateStr} の学習を記録・編集`;
            
            const recordsForDay = logsByDate[dateStr] || {};
            const firstSubjectId = Object.keys(recordsForDay)[0];
            commentInput.value = firstSubjectId ? (recordsForDay[firstSubjectId].comment || '') : '';
            modal.querySelectorAll('.subject-log-row').forEach(row => {
                const subjectId = row.dataset.subjectId;
                const totalMinutes = recordsForDay[String(subjectId)] || 0;
                row.dataset.totalMinutes = totalMinutes;
                updateDisplay(row);
            });
            modal.showModal();
        });
    }

    modal.addEventListener('click', (e) => {
        if (e.target.matches('.close') || e.target.getAttribute('href') === '#cancel') {
            e.preventDefault();
            modal.close();
        } else if (e.target.matches('.time-btn')) {
            const subjectRow = e.target.closest('.subject-log-row');
            const change = parseInt(e.target.dataset.change, 10);
            let currentMinutes = parseInt(subjectRow.dataset.totalMinutes, 10) || 0;
            subjectRow.dataset.totalMinutes = Math.max(0, currentMinutes + change);
            updateDisplay(subjectRow);
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const saveBtn = document.getElementById('save-log-btn');
        saveBtn.setAttribute('aria-busy', 'true');
        saveBtn.textContent = '保存中...';

        const logs = Array.from(form.querySelectorAll('.subject-log-row')).map(row => {
            const totalMinutes = parseInt(row.dataset.totalMinutes, 10);
            return {
                subject_id: row.dataset.subjectId,
                hours: String(Math.floor(totalMinutes / 60)),
                minutes: String(totalMinutes % 60),
            };
        });

        try {
            const response = await fetch("{{ url_for('main.log_study_for_date', user_id=user.id) }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: dateInput.value, logs: logs, comment: commentInput.value })
            });
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else { throw new Error('API request failed'); }
        } catch (error) {
            console.error('記録の保存に失敗:', error);
            alert('エラーが発生しました。記録の保存に失敗しました。');
            saveBtn.removeAttribute('aria-busy');
            saveBtn.textContent = 'この日の記録を保存';
        }
    });
    // ▼▼▼ ここから「今日」をハイライトする処理を追加 ▼▼▼
    // ユーザーのブラウザのタイムゾーンで「今日」の日付をYYYY-MM-DD形式で取得
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}-${mm}-${dd}`;

    // カレンダーの中から今日の日付に一致する要素を探す
    const todayElement = document.querySelector(`.day[data-date="${todayStr}"]`);
    if (todayElement) {
        // is-todayクラスを追加してハイライト
        todayElement.classList.add('is-today');
    }

    // is-todayクラスを追加してハイライト
  todayElement.classList.add('is-today');
}

// ▼▼▼ ここからヒートマップのコードを追加 ▼▼▼
const heatmapData = {{ heatmap_data|tojson|safe }};
const cal = new CalHeatmap();
cal.paint({
  itemSelector: "#cal-heatmap",
  domain: { type: "month" },
  subDomain: { type: "ghDay", width: 15, height: 15, radius: 3 },
  data: { source: heatmapData, x: 'date', y: 'value' },
  scale: {
    color: {
      type: 'threshold',
      range: ['#c6e48b', '#7bc96f', '#239a3b', '#196127'],
      domain: [60, 180, 300],
    },
  },
  date: { start: new Date(new Date().getFullYear(), 0, 1) },
  theme: "light"
});

);
</script>
{% endblock %}
{% endblock %}