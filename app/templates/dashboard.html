{% extends "base.html" %}

{% block title %}マイページ{% endblock %}

{% block content %}
<div id="welcome-modal-overlay" class="modal-overlay">
    <div class="modal-container">
        <span id="modal-close-button" class="modal-close-button">&times;</span>
        <h2>ようこそ、みちしるべへ！</h2>
        <p>あなたの目標達成を全力でサポートします。まずは基本的な使い方を覚えましょう！</p>
        
        <hr>

        <h4><span style="color: #007bff;">今日やること</span>：今日のフォーカス</h4>
        <p>マイページ中央の「今日のフォーカス」には、あなたが今日取り組むべきタスクが表示されます。まずはここに表示された参考書の学習から始めましょう！</p>
        
        <h4><span style="color: #28a745;">今の実力</span>：学習進捗</h4>
        <p>右側の「学習進捗」バーで、各科目の習熟度がひと目でわかります。学習を進めてバーを伸ばしていきましょう。</p>

        <h4><span style="color: #ffc107;">全体の計画</span>：学習マップ</h4>
        <p>上部メニューの「学習マップ」では、志望校合格までの全ての学習ステップを地図のように確認できます。</p>

        <button id="modal-start-button" class="contrast">はじめる</button>
    </div>
</div>
<article>
    <hgroup>
        <h1>マイページ</h1>
        <h2>こんにちは、{{ user.username }}さん！</h2>
        <h2>あなたの目標は <strong>{{ user.school }} {{ user.faculty }}</strong> です。</h2>
        {% if days_until_exam != "未設定" and days_until_exam >= 0 %}
           <p>第一志望の試験日まで、あと<strong>{{ days_until_exam }}</strong>日。頑張りましょう！🔥</p>
        {% endif %}
        {% if user.learning_style %}
           <p>あなたの学習スタイル: <strong>{{ user.learning_style }}</strong> - <a href="{{ url_for('main.quiz_results', user_id=user.id) }}">詳細を見る</a></p>
        {% endif %}
    </hgroup>
</article>

<div class="dashboard-grid">

    <div class="dashboard-main">
        <article class="dashboard-card">
            <h3>今日のフォーカス</h3>
            <p>まずはここから始めよう！各科目の「次の１冊」と「毎日やるタスク」です。</p>
            
            {% for subject in dashboard_data %}
            <div class="focus-subject-group">
                <h4>{{ subject.name }}</h4>
                <div class="focus-task-list">
                    {% for c_task in subject.continuous_tasks %}
                    <div class="focus-task-item continuous">
                        <span class="task-icon">🔁</span>
                        <div class="task-details">
                            <strong>{{ c_task.title }}</strong>
                            <small>継続タスク</small>
                        </div>
                    </div>
                    {% endfor %}

                    {% if subject.pending_selections %}
                    <div class="focus-task-item pending-selection">
                        <span class="task-icon">👉</span>
                        <div class="task-details">
                            <strong>選択が必要です</strong>
                            <small>「{{ subject.pending_selections | join(', ') }}」の参考書を選んでください</small>
                        </div>
                        <div class="task-actions">
                            <a href="{{ url_for('main.show_plan', user_id=user.id, subject=subject.name) }}" role="button" class="contrast">選択する</a>
                        </div>
                    </div>
                    {% endif %}

                    {% if subject.next_task %}
                        
                        {# is_choice_pendingキーが存在するかどうかで、どちらのデータかを判断 #}
                        {% if subject.next_task.is_choice_pending is defined %}
                            <div class="focus-task-item pending-selection">
                                <span class="task-icon">👉</span>
                                <div class="task-details">
                                    <strong>{{ subject.next_task.title }}</strong>
                                    <small>学習マップで次に進む参考書を選んでください。</small>
                                </div>
                                <div class="task-actions">
                                    <a href="{{ url_for('main.show_plan', user_id=user.id, subject=subject.next_task.subject_name) }}" role="button" class="contrast">選択する</a>
                                </div>
                            </div>
                        
                        {# 通常のタスクデータの場合 #}
                        {% else %}
                            {% if subject.next_task.task_id.startswith('level_check_') %}
                                <div class="focus-task-item level-up">
                                    <span class="task-icon">🏆</span>
                                    <div class="task-details">
                                        <strong>{{ subject.next_task.title }}</strong>
                                        <small>おめでとう！過去問を解いて実力を試しましょう。</small>
                                    </div>
                                    <div class="task-actions level-up-actions">
                                        <a href="https://www.toshin-kakomon.com/" target="_blank" rel="noopener noreferrer" role="button" class="secondary outline">東進過去問DB</a>
                                        {% if university and university.info_url %}
                                        <a href="{{ university.info_url }}" target="_blank" rel="noopener noreferrer" role="button" class="secondary outline">パスナビで探す</a>
                                        {% endif %}
                                        <button class="complete-btn" 
        data-task-id="{{ subject.next_task.task_id }}" 
        data-subject-id="{{ subject.id }}">クリア</button>
                                    </div>
                                </div>
                            {% else %}
                                <div class="focus-task-item sequential">
                                    <span class="task-icon">📖</span>
                                    <div class="task-details">
                                        <strong>{{ subject.next_task.title }}</strong>
                                        <small>次の参考書</small>
                                    </div>
                                    <div class="task-actions">
                                        <button class="contrast outline complete-btn" 
        data-task-id="{{ subject.next_task.task_id }}" 
        data-subject-id="{{ subject.id }}">✔️ 完了</button> 
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}

                    {% elif not subject.continuous_tasks and not subject.pending_selections %}
                        <div class="focus-task-item all-done">
                            <span class="task-icon">🎉</span>
                            <div class="task-details">
                                <strong>すべてのタスクが完了しています！</strong>
                                <small>素晴らしい！</small>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if subject.last_completed_task %}
                    <div class="focus-task-item last-completed">
                        <span class="task-icon">✅</span>
                        <div class="task-details">
                            <strong>{{ subject.last_completed_task.title }}</strong>
                            <small>直前に完了したタスク</small>
                        </div>
                        <div class="task-actions">
                            <button class="secondary outline uncomplete-btn" 
        data-task-id="{{ subject.last_completed_task.task_id }}" 
        data-subject-id="{{ subject.id }}">↩︎ 未完了に戻す</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </article>
    </div>

    <div class="dashboard-side">
        <article class="dashboard-card">
            <h3>学習進捗</h3>
            {% for subject in dashboard_data %}
            <div class="progress-group">
                <label for="progress-{{ subject.name }}">{{ subject.name }}</label>
                <progress id="progress-{{ subject.name }}" value="{{ subject.progress }}" max="100"></progress>
            </div>
            {% endfor %}
        </article>
        <article class="dashboard-card">
             <h3>学習スタイル診断</h3>
             <p>自分に合った学習法を見つけて、効率を最大化しよう。</p>
             <a href="{{ url_for('main.quiz', user_id=user.id) }}" role="button">診断を受ける</a>
        </article>
        <article class="dashboard-card">
            <h3>志望校情報</h3>
            <p><strong>{{ user.school }}</strong></p>
            <p>試験日まで、あと <strong>{{ days_until_exam }}</strong> 日</p>
            {% if university and university.info_url %}
            <a href="{{ university.info_url }}" role="button" class="contrast" target="_blank" rel="noopener noreferrer">大学情報を確認</a>
            {% endif %}
        </article>
        <article class="dashboard-card">
            <h3>学習マップ</h3>
            <p>学習の全体像を確認して、自分の現在地を把握しよう。</p>
            <a href="{{ url_for('main.show_plan', user_id=user.id) }}" role="button">学習マップを見る</a>
        </article>
        <article class="dashboard-card">
    <h3>模試の記録</h3>
    <p>模試の予定と結果を記録して、実力の推移を把握しよう。</p>
    <a href="{{ url_for('main.mock_exams', user_id=user.id) }}" role="button">模試を記録する</a>
</article>
    </div>
</div>

<script>
    // --- チュートリアルモーダル用のJavaScript ---

    // 1. 必要なHTML要素をIDで取得します
    const modalOverlay = document.getElementById('welcome-modal-overlay');
    const closeButton = document.getElementById('modal-close-button');
    const startButton = document.getElementById('modal-start-button');

    // 2. モーダルを開くための関数を定義します
    function openModal() {
        // modalOverlayが存在する場合のみ処理を実行
        if (modalOverlay) {
            // CSSで display: none; になっているものを display: flex; に変更して表示
            modalOverlay.style.display = 'flex';
        }
    }

    // 3. モーダルを閉じるための関数を定義します
    function closeModal() {
        // modalOverlayが存在する場合のみ処理を実行
        if (modalOverlay) {
            // CSSの display を none に戻して非表示に
            modalOverlay.style.display = 'none';
        }
    }

    // 4. 各要素がクリックされたときのイベントを設定します
    // 閉じるボタンがクリックされたら、closeModal関数を実行
    if (closeButton) {
        closeButton.addEventListener('click', closeModal);
    }

    // 「はじめる」ボタンがクリックされたら、closeModal関数を実行
    if (startButton) {
        startButton.addEventListener('click', closeModal);
    }
    
    // 背景のオーバーレイ自体がクリックされたときもモーダルを閉じる
    if (modalOverlay) {
        modalOverlay.addEventListener('click', function(event) {
            // クリックされたのが、内側の白いウィンドウではなく、外側の黒い背景部分の場合のみ実行
            if (event.target === modalOverlay) {
                closeModal();
            }
        });
    }


    // 5. Flaskから送られた「合図」を受け取り、モーダルを自動で開きます
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          {# registerルートから 'show_welcome_modal' というメッセージが送られてきた場合 #}
          {% if message == 'show_welcome_modal' %}
            // HTMLドキュメントが完全に読み込まれたら、openModal関数を実行
            document.addEventListener('DOMContentLoaded', openModal);
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endwith %}


   // --- 進捗更新用のJavaScript ---
    
// ▼▼▼ 「完了」ボタン用の処理 (既存のコード) ▼▼▼
document.querySelectorAll('.complete-btn').forEach(button => {
    button.addEventListener('click', function() {
        const taskId = this.dataset.taskId;
        const subjectId = this.dataset.subjectId;
        
        fetch('/api/update_progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                task_id: taskId, 
                subject_id: subjectId,
                is_completed: true // タスクを「完了」に設定
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('進捗の更新に失敗しました。');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('サーバーとの通信中にエラーが発生しました。');
        });
    });
});

// ▼▼▼ 「未完了に戻す」ボタン用の処理 (ここからが追加部分) ▼▼▼
document.querySelectorAll('.uncomplete-btn').forEach(button => {
    button.addEventListener('click', function() {
        const taskId = this.dataset.taskId;
        const subjectId = this.dataset.subjectId;
        
        fetch('/api/update_progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                task_id: taskId, 
                subject_id: subjectId,
                is_completed: false // ★タスクを「未完了」に設定
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('進捗の更新に失敗しました。');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('サーバーとの通信中にエラーが発生しました。');
        });
    });
});
</script>
{% endblock %}