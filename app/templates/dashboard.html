{% extends "base.html" %}

{% block title %}ãƒã‚¤ãƒšãƒ¼ã‚¸{% endblock %}

{% block content %}

<article>
    <hgroup>
        <h1>ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
        <h2>ã“ã‚“ã«ã¡ã¯ã€{{ user.username }}ã•ã‚“ï¼</h2>
        <h2>ã‚ãªãŸã®ç›®æ¨™ã¯ <strong>{{ user.school }} {{ user.faculty }}</strong> ã§ã™ã€‚</h2>
        {% if days_until_exam != "æœªè¨­å®š" and days_until_exam >= 0 %}
            <p>ç¬¬ä¸€å¿—æœ›ã®è©¦é¨“æ—¥ã¾ã§ã€ã‚ã¨<strong>{{ days_until_exam }}</strong>æ—¥ã€‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼ğŸ”¥</p>
        {% endif %}
        {% if user.learning_style %}
            <p>ã‚ãªãŸã®å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«: <strong>{{ user.learning_style }}</strong> - <a href="{{ url_for('main.quiz_results') }}">è©³ç´°ã‚’è¦‹ã‚‹</a></p>
        {% endif %}
    </hgroup>
    
    {% if upcoming_exams %}
    <div class="exam-notification">
        <h4>ğŸ“¢ ã‚ãªãŸã¸ã®ãŠã™ã™ã‚æ¨¡è©¦</h4>
        {% for exam in upcoming_exams %}
        <article style="padding: 1rem; margin-bottom: 1rem;">
            <strong>{{ exam.provider }} - {{ exam.name }}</strong> (å¯¾è±¡: {{ exam.target_grade }})<br>
            <small>å®Ÿæ–½æ—¥: {{ exam.exam_date.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</small>
            {% if exam.app_end_date and exam.app_end_date >= date.today() %}
                <small style="color: red; margin-left: 1rem;">ç”³è¾¼ç· åˆ‡: {{ exam.app_end_date.strftime('%mæœˆ%dæ—¥') }}</small>
            {% endif %}
            <a href="{{ exam.url }}" target="_blank" rel="noopener noreferrer" role="button" class="contrast outline" style="float: right;">å…¬å¼ã‚µã‚¤ãƒˆã¸</a>
        </article>
        {% endfor %}
    </div>
    {% endif %}
</article>

{% if unread_replies %}
<article class="notification-info">
  <hgroup>
    <h4>ğŸ“¢ ç®¡ç†è€…ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</h4>
    <p>ãŠå•ã„åˆã‚ã›ã¸ã®è¿”ä¿¡ãŒå±Šã„ã¦ã„ã¾ã™ã€‚</p>
  </hgroup>
  {% for reply in unread_replies %}
    <details>
      <summary><strong>è¿”ä¿¡æ—¥æ™‚:</strong> {{ reply.created_at.strftime('%Y-%m-%d %H:%M') }}</summary>
      <p><strong>ã€ã‚ãªãŸã®è³ªå•ã€‘</strong><br>{{ reply.inquiry.message }}</p>
      <p><strong>ã€ç®¡ç†è€…ã‹ã‚‰ã®å›ç­”ã€‘</strong><br>{{ reply.message }}</p>
      </details>
  {% endfor %}
</article>
{% endif %}

<div class="dashboard-grid">
    <div class="dashboard-main">
        <article class="dashboard-card">
            <h3>ä»Šæ—¥ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</h3>
            <p>ã¾ãšã¯ã“ã“ã‹ã‚‰å§‹ã‚ã‚ˆã†ï¼å„ç§‘ç›®ã®ã€Œæ¬¡ã®ï¼‘å†Šã€ã¨ã€Œæ¯æ—¥ã‚„ã‚‹ã‚¿ã‚¹ã‚¯ã€ã§ã™ã€‚</p>
            
            {% for subject in dashboard_data %}
            <div class="focus-subject-group">
                <h4>{{ subject.name }}</h4>
                <div class="focus-task-list">
                    {% for c_task in subject.continuous_tasks %}
                    <div class="focus-task-item continuous">
                        <span class="task-icon">ğŸ”</span>
                        <div class="task-details">
                            <strong>{{ c_task.title }}</strong>
                            <small>ç¶™ç¶šã‚¿ã‚¹ã‚¯</small>
                        </div>
                    </div>
                    {% endfor %}

                    {% if subject.pending_selections %}
                    <div class="focus-task-item pending-selection">
                        <span class="task-icon">ğŸ‘‰</span>
                        <div class="task-details">
                            <strong>é¸æŠãŒå¿…è¦ã§ã™</strong>
                            <small>ã€Œ{{ subject.pending_selections | join(', ') }}ã€ã®å‚è€ƒæ›¸ã‚’é¸ã‚“ã§ãã ã•ã„</small>
                        </div>
                        <div class="task-actions">
                            <a href="{{ url_for('main.show_plan', user_id=user.id, subject_name=subject.name, _anchor=subject.pending_selections[0]) }}" role="button" class="contrast">é¸æŠã™ã‚‹</a>
                        </div>
                    </div>
                    {% endif %}

                    {% if subject.next_task %}
                        {% if subject.next_task.is_choice_pending is defined %}
                        <div class="focus-task-item pending-selection">
                            <span class="task-icon">ğŸ‘‰</span>
                            <div class="task-details">
                                <strong>{{ subject.next_task.title }}</strong>
                                <small>å­¦ç¿’ãƒãƒƒãƒ—ã§æ¬¡ã«é€²ã‚€å‚è€ƒæ›¸ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</small>
                            </div>
                            <div class="task-actions">
                            <a href="/plan/{{ user.id }}?subject_name={{ subject.name }}#{{ subject.next_task.level }}" role="button" class="contrast">é¸æŠã™ã‚‹</a>
                        </div>
                        {% else %}
                            {% if subject.next_task.task_id.startswith('level_check_') %}
                            <div class="focus-task-item level-up">
                                <span class="task-icon">ğŸ†</span>
                                <div class="task-details">
                                    <strong>{{ subject.next_task.title }}</strong>
                                    <small>ãŠã‚ã§ã¨ã†ï¼éå»å•ã‚’è§£ã„ã¦å®ŸåŠ›ã‚’è©¦ã—ã¾ã—ã‚‡ã†ã€‚</small>
                                </div>
                                <div class="task-actions level-up-actions">
                                    <a href="https://www.toshin-kakomon.com/" target="_blank" rel="noopener noreferrer" role="button" class="secondary outline">æ±é€²éå»å•DB</a>
                                    {% if university and university.info_url %}
                                    <a href="{{ university.info_url }}" target="_blank" rel="noopener noreferrer" role="button" class="secondary outline">ãƒ‘ã‚¹ãƒŠãƒ“ã§æ¢ã™</a>
                                    {% endif %}
                                    <button class="complete-btn" data-task-id="{{ subject.next_task.task_id }}" data-subject-id="{{ subject.id }}">ã‚¯ãƒªã‚¢</button>
                                </div>
                            </div>
                            {% else %}
                            <div class="focus-task-item sequential clickable-task" 
     data-title="{{ subject.next_task.title }}" 
     data-description="{{ subject.next_task.description }}" 
     data-youtube-query="{{ subject.next_task.youtube_query }}">
                                <span class="task-icon">ğŸ“–</span>
                                <div class="task-details">
                                    <strong>{{ subject.next_task.title }}</strong>
                                    <small>æ¬¡ã®å‚è€ƒæ›¸</small>
                                </div>
                                <div class="task-actions">
                                    <button class="contrast outline complete-btn" data-task-id="{{ subject.next_task.task_id }}" data-subject-id="{{ subject.id }}">âœ”ï¸ å®Œäº†</button>
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                    {% elif not subject.continuous_tasks and not subject.pending_selections %}
                    <div class="focus-task-item all-done">
                        <span class="task-icon">ğŸ‰</span>
                        <div class="task-details">
                            <strong>ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¦ã„ã¾ã™ï¼</strong>
                            <small>ç´ æ™´ã‚‰ã—ã„ï¼</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if subject.last_completed_task %}
                    <div class="focus-task-item last-completed clickable-task"
     data-title="{{ subject.last_completed_task.title }}"
     data-description="{{ subject.last_completed_task.description }}"
     data-youtube-query="{{ subject.last_completed_task.youtube_query }}">
                        <span class="task-icon">âœ…</span>
                        <div class="task-details">
                            <strong>{{ subject.last_completed_task.title }}</strong>
                            <small>ç›´å‰ã«å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯</small>
                        </div>
                        <div class="task-actions">
                            <button class="secondary outline uncomplete-btn" data-task-id="{{ subject.last_completed_task.task_id }}" data-subject-id="{{ subject.id }}">â†©ï¸ æœªå®Œäº†ã«æˆ»ã™</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </article>
    </div>

    <div class="dashboard-side">
        <article class="dashboard-card">
            <h3>å­¦ç¿’é€²æ—</h3>
            {% for subject in dashboard_data %}
            <div class="progress-group">
                <label for="progress-{{ subject.name }}">{{ subject.name }}</label>
                <progress id="progress-{{ subject.name }}" value="{{ subject.progress }}" max="100"></progress>
            </div>
            {% endfor %}
        </article>
        <article class="dashboard-card">
            <h3>å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«è¨ºæ–­</h3>
            <p>è‡ªåˆ†ã«åˆã£ãŸå­¦ç¿’æ³•ã‚’è¦‹ã¤ã‘ã¦ã€åŠ¹ç‡ã‚’æœ€å¤§åŒ–ã—ã‚ˆã†ã€‚</p>
            <a href="{{ url_for('main.quiz', user_id=user.id) }}" role="button">è¨ºæ–­ã‚’å—ã‘ã‚‹</a>
        </article>
        </div>
</div>
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- é€²æ—æ›´æ–°ç”¨ã®JavaScript ---
    function handleProgressUpdate(button, isCompleted) {
        const taskId = button.dataset.taskId;
        const subjectId = button.dataset.subjectId;
        
        button.setAttribute('aria-busy', 'true');

        fetch('/api/update_progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                task_id: taskId, 
                subject_id: subjectId,
                is_completed: isCompleted
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('é€²æ—ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                button.removeAttribute('aria-busy');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            button.removeAttribute('aria-busy');
        });
    }

    document.querySelectorAll('.complete-btn').forEach(button => {
        button.addEventListener('click', () => handleProgressUpdate(button, true));
    });

    document.querySelectorAll('.uncomplete-btn').forEach(button => {
        button.addEventListener('click', () => handleProgressUpdate(button, false));
    });
});
document.addEventListener('DOMContentLoaded', () => {
    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç”¨ã®JavaScript ---
    const taskModal = document.getElementById('task-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalDescription = document.getElementById('modal-description');
    const modalYoutubeLink = document.getElementById('modal-youtube-link');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹æ©Ÿèƒ½
    function closeModal() {
        if (taskModal.hasAttribute("open")) taskModal.close();
    }
    taskModal.addEventListener('click', (event) => {
        if (event.target === taskModal) closeModal();
    });
    taskModal.querySelector('.close').addEventListener('click', closeModal);

    // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªã‚¿ã‚¹ã‚¯å…¨ã¦ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.querySelectorAll('.clickable-task').forEach(taskElement => {
        taskElement.addEventListener('click', (event) => {
            // ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã‹ãªã„
            if (event.target.tagName === 'BUTTON' || event.target.tagName === 'A') {
                return;
            }
            
            // HTMLã«åŸ‹ã‚è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const title = taskElement.dataset.title;
            const description = taskElement.dataset.description;
            const youtubeQuery = taskElement.dataset.youtubeQuery;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸­èº«ã‚’æ›´æ–°
            modalTitle.textContent = title;
            modalDescription.textContent = description || 'èª¬æ˜ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
            modalYoutubeLink.href = `https://www.youtube.com/results?search_query=${encodeURIComponent(youtubeQuery)}`;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            taskModal.showModal();
        });
    });
});
</script>
<dialog id="task-modal">
    <article>
        <header>
            <a href="#close" aria-label="Close" class="close"></a>
            <h4 id="modal-title">å‚è€ƒæ›¸ã‚¿ã‚¤ãƒˆãƒ«</h4>
        </header>
        <p id="modal-description">ã“ã“ã«èª¬æ˜ãŒå…¥ã‚Šã¾ã™ã€‚</p>
        <footer>
            <a id="modal-youtube-link" href="#" role="button" class="contrast" target="_blank" rel="noopener noreferrer">YouTubeã§ä½¿ã„æ–¹ã‚’æ¤œç´¢</a>
        </footer>
    </article>
</dialog>
{% endblock %}
{% endblock %}