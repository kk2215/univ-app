{% extends "base.html" %}

{% block title %}ãƒã‚¤ãƒšãƒ¼ã‚¸{% endblock %}

{% block content %}
<article>
    <hgroup>
        <h1>ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
        <h2>ã“ã‚“ã«ã¡ã¯ã€{{ user.username }}ã•ã‚“ï¼</h2>
    </hgroup>
</article>

<div class="dashboard-grid">

    <div class="dashboard-main">
        <article class="dashboard-card">
            <h3>ä»Šæ—¥ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</h3>
            <p>ã¾ãšã¯ã“ã“ã‹ã‚‰å§‹ã‚ã‚ˆã†ï¼å„ç§‘ç›®ã®ã€Œæ¬¡ã®ï¼‘å†Šã€ã¨ã€Œæ¯æ—¥ã‚„ã‚‹ã‚¿ã‚¹ã‚¯ã€ã§ã™ã€‚</p>
            
            {% for subject in dashboard_data %}
            <div class="focus-subject-group">
                <h4>{{ subject.name }}</h4>
                <div class="focus-task-list">
                    {% for c_task in subject.continuous_tasks %}
                    <div class="focus-task-item continuous">
                        <span class="task-icon">ğŸ”</span>
                        <div class="task-details">
                            <strong>{{ c_task.title }}</strong>
                            <small>ç¶™ç¶šã‚¿ã‚¹ã‚¯</small>
                        </div>
                    </div>
                    {% endfor %}

                    {% if subject.pending_selections %}
                    <div class="focus-task-item pending-selection">
                        <span class="task-icon">ğŸ‘‰</span>
                        <div class="task-details">
                            <strong>é¸æŠãŒå¿…è¦ã§ã™</strong>
                            <small>ã€Œ{{ subject.pending_selections | join(', ') }}ã€ã®å‚è€ƒæ›¸ã‚’é¸ã‚“ã§ãã ã•ã„</small>
                        </div>
                        <div class="task-actions">
                            <a href="{{ url_for('main.show_plan', user_id=user.id, subject=subject.name) }}" role="button" class="contrast">é¸æŠã™ã‚‹</a>
                        </div>
                    </div>
                    {% endif %}

                    {% if subject.next_task %}
                        
                        {# is_choice_pendingã‚­ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹ã§ã€ã©ã¡ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚’åˆ¤æ–­ #}
                        {% if subject.next_task.is_choice_pending is defined %}
                            <div class="focus-task-item pending-selection">
                                <span class="task-icon">ğŸ‘‰</span>
                                <div class="task-details">
                                    <strong>{{ subject.next_task.title }}</strong>
                                    <small>å­¦ç¿’ãƒãƒƒãƒ—ã§æ¬¡ã«é€²ã‚€å‚è€ƒæ›¸ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</small>
                                </div>
                                <div class="task-actions">
                                    <a href="{{ url_for('main.show_plan', user_id=user.id, subject=subject.next_task.subject_name) }}" role="button" class="contrast">é¸æŠã™ã‚‹</a>
                                </div>
                            </div>
                        
                        {# é€šå¸¸ã®ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®å ´åˆ #}
                        {% else %}
                            {% if subject.next_task.task_id.startswith('level_check_') %}
                                <div class="focus-task-item level-up">
                                    <span class="task-icon">ğŸ†</span>
                                    <div class="task-details">
                                        <strong>{{ subject.next_task.title }}</strong>
                                        <small>ãŠã‚ã§ã¨ã†ï¼éå»å•ã‚’è§£ã„ã¦å®ŸåŠ›ã‚’è©¦ã—ã¾ã—ã‚‡ã†ã€‚</small>
                                    </div>
                                    <div class="task-actions level-up-actions">
                                        <a href="https://www.toshin-kakomon.com/" target="_blank" rel="noopener noreferrer" role="button" class="secondary outline">æ±é€²éå»å•DB</a>
                                        {% if university and university.info_url %}
                                        <a href="{{ university.info_url }}" target="_blank" rel="noopener noreferrer" role="button" class="secondary outline">ãƒ‘ã‚¹ãƒŠãƒ“ã§æ¢ã™</a>
                                        {% endif %}
                                        <button class="complete-btn" data-task-id="{{ subject.next_task.task_id }}">ã‚¯ãƒªã‚¢</button>
                                    </div>
                                </div>
                            {% else %}
                                <div class="focus-task-item sequential">
                                    <span class="task-icon">ğŸ“–</span>
                                    <div class="task-details">
                                        <strong>{{ subject.next_task.title }}</strong>
                                        <small>æ¬¡ã®å‚è€ƒæ›¸</small>
                                    </div>
                                    <div class="task-actions">
                                        <button class="contrast outline complete-btn" data-task-id="{{ subject.next_task.task_id }}">âœ”ï¸ å®Œäº†</button>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}

                    {% elif not subject.continuous_tasks and not subject.pending_selections %}
                        <div class="focus-task-item all-done">
                            <span class="task-icon">ğŸ‰</span>
                            <div class="task-details">
                                <strong>ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¦ã„ã¾ã™ï¼</strong>
                                <small>ç´ æ™´ã‚‰ã—ã„ï¼</small>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if subject.last_completed_task %}
                    <div class="focus-task-item last-completed">
                        <span class="task-icon">âœ…</span>
                        <div class="task-details">
                            <strong>{{ subject.last_completed_task.title }}</strong>
                            <small>ç›´å‰ã«å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯</small>
                        </div>
                        <div class="task-actions">
                            <button class="secondary outline uncomplete-btn" data-task-id="{{ subject.last_completed_task.task_id }}">â†©ï¸ æœªå®Œäº†ã«æˆ»ã™</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </article>
    </div>

    <div class="dashboard-side">
        <article class="dashboard-card">
            <h3>å­¦ç¿’é€²æ—</h3>
            {% for subject in dashboard_data %}
            <div class="progress-group">
                <label for="progress-{{ subject.name }}">{{ subject.name }}</label>
                <progress id="progress-{{ subject.name }}" value="{{ subject.progress }}" max="100"></progress>
            </div>
            {% endfor %}
        </article>
        <article class="dashboard-card">
            <h3>å¿—æœ›æ ¡æƒ…å ±</h3>
            <p><strong>{{ user.school }}</strong></p>
            <p>è©¦é¨“æ—¥ã¾ã§ã€ã‚ã¨ <strong>{{ days_until_exam }}</strong> æ—¥</p>
            {% if university and university.info_url %}
            <a href="{{ university.info_url }}" role="button" class="contrast" target="_blank" rel="noopener noreferrer">å¤§å­¦æƒ…å ±ã‚’ç¢ºèª</a>
            {% endif %}
        </article>
        <article class="dashboard-card">
            <h3>å­¦ç¿’ãƒãƒƒãƒ—</h3>
            <p>å­¦ç¿’ã®å…¨ä½“åƒã‚’ç¢ºèªã—ã¦ã€è‡ªåˆ†ã®ç¾åœ¨åœ°ã‚’æŠŠæ¡ã—ã‚ˆã†ã€‚</p>
            <a href="{{ url_for('main.show_plan', user_id=user.id) }}" role="button">å­¦ç¿’ãƒãƒƒãƒ—ã‚’è¦‹ã‚‹</a>
        </article>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.complete-btn').forEach(button => {
        button.addEventListener('click', (event) => {
            handleProgressUpdate(event.target, true);
        });
    });
    document.querySelectorAll('.uncomplete-btn').forEach(button => {
        button.addEventListener('click', (event) => {
            handleProgressUpdate(event.target, false);
        });
    });
    async function handleProgressUpdate(buttonElement, isCompleted) {
        const taskId = buttonElement.dataset.taskId;
        buttonElement.disabled = true;
        const originalText = buttonElement.textContent;
        buttonElement.textContent = 'ä¿å­˜ä¸­...';
        try {
            const response = await fetch("{{ url_for('main.update_progress') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_id: taskId, is_completed: isCompleted })
            });
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                throw new Error('API request failed');
            }
        } catch (error) {
            console.error('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            buttonElement.disabled = false;
            buttonElement.textContent = originalText;
        }
    }
});
</script>
{% endblock %}