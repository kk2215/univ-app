{% extends 'base.html' %}
{% block title %}{% if exam %}模試の編集{% else %}新しい模試の追加{% endif %}{% endblock %}
{% block content %}
<article>
    <hgroup>
        <h1>{% if exam %}模試の編集{% else %}新しい模試の追加{% endif %}</h1>
        <p>URLを貼り付けて「情報取得」ボタンを押すと、AIが自動で入力欄を埋めます。</p>
    </hgroup>

    <div class="grid">
        <input type="url" id="source-url" placeholder="模試の公式サイトURLをここに貼り付け">
        <button id="fetch-btn" class="secondary" style="width: auto;">情報取得</button>
    </div>
    <hr>
    <div id="exam-candidates"></div>
    <form method="post">
        <label for="provider">提供元</label>
        <input type="text" id="provider" name="provider" value="{{ exam.provider if exam else '' }}" required>

        <label for="name">模試名</label>
        <input type="text" id="name" name="name" value="{{ exam.name if exam else '' }}" required>

        <div class="grid">
            <label for="exam_date">実施日</label>
            <label for="app_start_date">申込開始日</label>
            <label for="app_end_date">申込締切日</label>
        </div>
        <div class="grid">
            <input type="date" id="exam_date" name="exam_date" value="{{ exam.exam_date.strftime('%Y-%m-%d') if exam else '' }}" required>
            <input type="date" id="app_start_date" name="app_start_date" value="{{ exam.app_start_date.strftime('%Y-%m-%d') if exam else '' }}" required>
            <input type="date" id="app_end_date" name="app_end_date" value="{{ exam.app_end_date.strftime('%Y-%m-%d') if exam else '' }}" required>
        </div>

        <label for="url">公式サイトURL (登録用)</label>
        <input type="url" id="url" name="url" value="{{ exam.url if exam else '' }}" required>

        <button type="submit">{% if exam %}更新する{% else %}追加する{% endif %}</button>
    </form>
</article>

<script>
const fetchBtn = document.getElementById('fetch-btn');
const urlInput = document.getElementById('source-url');
const candidatesDiv = document.getElementById('exam-candidates');
const form = document.querySelector('form');

// フォームの各入力欄
const providerInput = document.getElementById('provider');
const nameInput = document.getElementById('name');
const examDateInput = document.getElementById('exam_date');
const appStartDateInput = document.getElementById('app_start_date');
const appEndDateInput = document.getElementById('app_end_date');
const finalUrlInput = document.getElementById('url');


// メインの「情報取得」ボタンの処理
fetchBtn.addEventListener('click', () => {
    fetchExamData(urlInput.value);
});

// URLから模試情報を取得する非同期関数
async function fetchExamData(url, isSecondAttempt = false) {
    if (!url) {
        alert('URLを入力してください。');
        return;
    }

    if (!isSecondAttempt) {
        candidatesDiv.innerHTML = ''; // 候補リストをリセット
    }
    fetchBtn.setAttribute('aria-busy', 'true');
    fetchBtn.textContent = 'AIが解析中...';

    try {
        const response = await fetch("{{ url_for('main.scrape_exam_url') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        });
        const result = await response.json();

        if (result.success) {
            if (result.is_index) {
                // 一覧ページの場合、候補を表示
                displayCandidates(result.exams_found);
            } else {
                // 詳細ページの場合、フォームに自動入力
                populateForm(result.data, url);
            }
        } else {
            alert('情報の取得に失敗しました: ' + result.error);
        }
    } catch (err) {
        alert('エラーが発生しました。');
    } finally {
        fetchBtn.removeAttribute('aria-busy');
        fetchBtn.textContent = '情報取得';
    }
}

// 候補リストを画面に表示する関数
function displayCandidates(exams) {
    candidatesDiv.innerHTML = '<h4>候補の模試:</h4><p>追加したい模試をクリックしてください。</p>';
    const list = document.createElement('div');
    exams.forEach(exam => {
        const item = document.createElement('a');
        item.href = '#';
        item.textContent = exam.name;
        item.className = 'candidate-item';
        item.style.display = 'block';
        item.style.marginBottom = '0.5rem';
        item.onclick = (e) => {
            e.preventDefault();
            // ユーザーが候補をクリックしたら、そのURLで再度情報を取得
            fetchExamData(exam.url, true);
        };
        list.appendChild(item);
    });
    candidatesDiv.appendChild(list);
}

// フォームにデータを自動入力する関数
function populateForm(data, url) {
    providerInput.value = data.provider || '';
    nameInput.value = data.name || '';
    examDateInput.value = data.exam_date || '';
    appStartDateInput.value = data.app_start_date || '';
    appEndDateInput.value = data.app_end_date || '';
    finalUrlInput.value = url; // URLは最後に使ったものを設定
    alert('AIによる自動入力が完了しました。内容を確認・修正してください。');
}
</script>
{% endblock %}