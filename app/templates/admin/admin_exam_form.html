{% extends 'base.html' %}
{% block title %}{% if exam %}模試の編集{% else %}新しい模試の追加{% endif %}{% endblock %}
{% block content %}
<article>
    <hgroup>
        <h1>{% if exam %}模試の編集{% else %}新しい模試の追加{% endif %}</h1>
        <p>提供元と模試テンプレートを選択すると、情報が自動入力されます。</p>
    </hgroup>
    
    <form method="post">
        <div class="grid">
            <label for="provider">提供元
                <select id="provider" name="provider" required>
                    <option value="" disabled {% if not exam %}selected{% endif %}>選択してください</option>
                    <option value="河合塾" {% if exam and exam.provider == '河合塾' %}selected{% endif %}>河合塾</option>
                    <option value="駿台" {% if exam and exam.provider == '駿台' %}selected{% endif %}>駿台</option>
                    <option value="東進" {% if exam and exam.provider == '東進' %}selected{% endif %}>東進</option>
                </select>
            </label>
            <label for="exam-template">模試テンプレート
                <select id="exam-template">
                    <option value="" disabled selected>まず提供元を選択</option>
                </select>
            </label>
        </div>

        <label for="name">模試名</label>
        <input type="text" id="name" name="name" value="{{ exam.name if exam else '' }}" required>

        <div class="grid">
            <label for="exam_date">実施日</label>
            <label for="app_start_date">申込開始日</label>
            <label for="app_end_date">申込締切日</label>
        </div>
        <div class="grid">
            <input type="date" id="exam_date" name="exam_date" value="{{ exam.exam_date.strftime('%Y-%m-%d') if exam and exam.exam_date else '' }}" required>
            <input type="date" id="app_start_date" name="app_start_date" value="{{ exam.app_start_date.strftime('%Y-%m-%d') if exam and exam.app_start_date else '' }}">
            <input type="date" id="app_end_date" name="app_end_date" value="{{ exam.app_end_date.strftime('%Y-%m-%d') if exam and exam.app_end_date else '' }}">
        </div>

        <label for="url">公式サイトURL (登録用)</label>
        <input type="url" id="url" name="url" value="{{ exam.url if exam else '' }}" required>

        <button type="submit">{% if exam %}更新する{% else %}追加する{% endif %}</button>
    </form>
</article>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const providerSelect = document.getElementById('provider');
    const templateSelect = document.getElementById('exam-template');
    const nameInput = document.getElementById('name');
    const urlInput = document.getElementById('url');

    providerSelect.addEventListener('change', async (e) => {
        const provider = e.target.value;
        if (!provider) return;

        templateSelect.innerHTML = '<option>テンプレートを読込中...</option>';
        
        const response = await fetch(`{{ url_for('main.get_exam_templates') }}?provider=${provider}`);
        const templates = await response.json();

        templateSelect.innerHTML = '<option value="" disabled selected>テンプレートを選択</option>';
        templates.forEach(template => {
            const option = document.createElement('option');
            option.value = JSON.stringify(template); // データをJSON文字列として保持
            option.textContent = template.name;
            templateSelect.appendChild(option);
        });
    });

    templateSelect.addEventListener('change', (e) => {
        if (!e.target.value) return;
        
        const selectedTemplate = JSON.parse(e.target.value);
        nameInput.value = selectedTemplate.name;
        urlInput.value = selectedTemplate.url || '';
    });
});
</script>
{% endblock %}